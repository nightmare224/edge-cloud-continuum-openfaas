---
- name: Fetch p2p public key to all faasd node
  hosts: edge
  tasks:
    - name: Transfer execution file for generate keypair
      copy:
        src: "{{ playbook_dir }}/roles/faasd/files/generate-p2p-keypair-arm64"
        dest: /opt/
        mode: '0755'
    - name: Generate keypair
      command: /opt/generate-p2p-keypair-arm64
    - name: Fetch public key
      fetch:
        src: /opt/p2p/pubKey
        dest: "{{ playbook_dir }}/roles/faasd/files/pubKey/{{ ansible_host }}"
        flat: true
    - name: Scatter p2p public key to all faasd node
      copy:
        src: "{{ playbook_dir }}/roles/faasd/files/pubKey/"
        dest: /opt/p2p/pubKey-peer/
  become: yes

- name: Install faasd
  hosts: edge
  roles:
    - role: common 
    - role: faasd
      become: yes
